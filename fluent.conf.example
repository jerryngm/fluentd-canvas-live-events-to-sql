<system>
  log_level trace
  log_event_verbose true
</system>
<source>
#doc: http://docs.fluentd.org/articles/in_http
  @type http
  port 9880
  #setup https - required by Canvas
  #get free cert from letsencrypt with certbot 
  #https://www.digitalocean.com/community/tutorials/how-to-use-certbot-standalone-mode-to-retrieve-let-s-encrypt-ssl-certificates-on-ubuntu-16-04
  <transport tls>
    cert_path /root/docker/ngixproxy/letsencrypt/live/npm-8/fullchain.pem
    private_key_path /root/docker/ngixproxy/letsencrypt/live/npm-8/privkey.pem
  </transport>
</source>

<source>
  @type monitor_agent
  port 24220
</source>
<source>
  @type debug_agent
  port 24230
</source>

#rewrite tag for filters
#doc: https://github.com/fluent/fluent-plugin-rewrite-tag-filter
@include config/canvas_tagrewriterules.conf


#record_transformer is a filter plug-in that allows transforming, deleting, and adding events
#With the enable_ruby option, an arbitrary Ruby expression can be used inside #${...}
<filter canvas.**> #get canvas metadata
  @type record_transformer
  enable_ruby
  <record> 
    @include config/filter/metadata/canvas_metadata.conf
  </record>
</filter>

#record_transformer filters to extract data from live events
@include config/filter/*.conf

#output data to SQL
<match canvas.**>
  #doc: https://github.com/fluent/fluent-plugin-sql
  @type sql
  host 127.0.0.1
  port 5432
  database canvas_data
  adapter postgresql
  username postgres
  password Musicazx2@
  schema_search_path public
  pool 10
 # socket path_to_socket
  remove_tag_prefix canvas.
<buffer>
flush_mode immediate
</buffer>

<table>
    table none
    column_mapping none:none
    # The default table is required.
</table>

@include config/output/*.conf

</match>



<match **>
  # http://docs.fluentd.org/articles/out_stdout
  @type stdout
</match>
